from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import CallbackContext, ConversationHandler
from database import db
from config import Config
import re
from datetime import datetime, timedelta

# Conversation states for job posting
JOB_TITLE, JOB_COMPANY, JOB_DESCRIPTION, JOB_REQUIREMENTS, JOB_SALARY, JOB_LOCATION, JOB_TYPE, JOB_CATEGORY, JOB_CONFIRM = range(9)

async def start_job_post(update: Update, context: CallbackContext):
    """Start job posting process"""
    user_id = update.effective_user.id
    
    # Check if user is registered as employer
    cursor = db.get_cursor()
    cursor.execute("SELECT user_type FROM users WHERE telegram_id = %s", (user_id,))
    user = cursor.fetchone()
    
    if not user:
        await update.message.reply_text(
            "‚ö†Ô∏è *Please create a profile first!*\n\n"
            "You need to set up your profile before posting jobs.\n"
            "Use /profile to create your profile.",
            parse_mode="Markdown"
        )
        return ConversationHandler.END
    
    if user['user_type'] != 'employer':
        await update.message.reply_text(
            "‚ö†Ô∏è *Employer Account Required*\n\n"
            "Your account is set as *Job Seeker*.\n"
            "To post jobs, you need an *Employer* account.\n\n"
            "Update your account type in profile settings.",
            parse_mode="Markdown"
        )
        return ConversationHandler.END
    
    await update.message.reply_text(
        "üìù *Post a New Job*\n\n"
        "Let's create your job posting step by step.\n\n"
        "*Step 1/9:* What is the job title?\n"
        "Example: *Senior Python Developer*",
        parse_mode="Markdown"
    )
    return JOB_TITLE

async def save_job_title(update: Update, context: CallbackContext):
    """Save job title"""
    context.user_data['job_title'] = update.message.text
    
    await update.message.reply_text(
        "*Step 2/9:* Company name:\n"
        "Example: *Zewed Tech Solutions*",
        parse_mode="Markdown"
    )
    return JOB_COMPANY

async def save_job_company(update: Update, context: CallbackContext):
    """Save company name"""
    context.user_data['company'] = update.message.text
    
    await update.message.reply_text(
        "*Step 3/9:* Job description:\n"
        "Describe the role, responsibilities, and what makes this job special.",
        parse_mode="Markdown"
    )
    return JOB_DESCRIPTION

async def save_job_description(update: Update, context: CallbackContext):
    """Save job description"""
    if len(update.message.text) < 50:
        await update.message.reply_text(
            "‚ùå Description too short. Please provide more details (at least 50 characters):"
        )
        return JOB_DESCRIPTION
    
    context.user_data['description'] = update.message.text
    
    await update.message.reply_text(
        "*Step 4/9:* Requirements:\n"
        "List the skills, qualifications, and experience required.\n"
        "Example:\n"
        "‚Ä¢ Bachelor's degree in Computer Science\n"
        "‚Ä¢ 3+ years Python experience\n"
        "‚Ä¢ Knowledge of Django/Flask",
        parse_mode="Markdown"
    )
    return JOB_REQUIREMENTS

async def save_job_requirements(update: Update, context: CallbackContext):
    """Save job requirements"""
    context.user_data['requirements'] = update.message.text
    
    await update.message.reply_text(
        "*Step 5/9:* Salary range (optional):\n"
        "Example: *ETB 25,000 - 40,000* or *Negotiable*",
        parse_mode="Markdown"
    )
    return JOB_SALARY

async def save_job_salary(update: Update, context: CallbackContext):
    """Save salary range"""
    context.user_data['salary_range'] = update.message.text
    
    await update.message.reply_text(
        "*Step 6/9:* Job location:\n"
        "Example: *Addis Ababa, Bole* or *Remote*",
        parse_mode="Markdown"
    )
    return JOB_LOCATION

async def save_job_location(update: Update, context: CallbackContext):
    """Save job location"""
    context.user_data['location'] = update.message.text
    
    # Create job type keyboard
    keyboard = []
    row = []
    for job_type_key, job_type_name in Config.JOB_TYPES.items():
        row.append(InlineKeyboardButton(job_type_name, callback_data=f"type_{job_type_key}"))
        if len(row) == 2:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    
    keyboard.append([InlineKeyboardButton("Skip", callback_data="type_skip")])
    
    await update.message.reply_text(
        "*Step 7/9:* Job type:",
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return JOB_TYPE

async def save_job_type(update: Update, context: CallbackContext):
    """Save job type from callback"""
    query = update.callback_query
    await query.answer()
    
    if query.data == "type_skip":
        context.user_data['job_type'] = 'full_time'
    else:
        job_type = query.data.replace("type_", "")
        context.user_data['job_type'] = job_type
    
    # Create category keyboard
    keyboard = []
    row = []
    for i, category in enumerate(Config.JOB_CATEGORIES, 1):
        row.append(InlineKeyboardButton(category, callback_data=f"cat_{i}"))
        if len(row) == 2:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    
    await query.message.reply_text(
        "*Step 8/9:* Job category:",
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return JOB_CATEGORY

async def save_job_category(update: Update, context: CallbackContext):
    """Save job category and show preview"""
    query = update.callback_query
    await query.answer()
    
    cat_index = int(query.data.replace("cat_", "")) - 1
    context.user_data['category'] = Config.JOB_CATEGORIES[cat_index]
    
    # Show preview
    job_data = context.user_data
    preview_text = f"""
üìã *JOB POSTING PREVIEW*

*Title:* {job_data['job_title']}
*Company:* {job_data.get('company', 'Not specified')}
*Location:* {job_data.get('location', 'Not specified')}
*Type:* {Config.JOB_TYPES.get(job_data.get('job_type', 'full_time'), 'Full Time')}
*Category:* {job_data.get('category', 'General')}
*Salary:* {job_data.get('salary_range', 'Negotiable')}

*Description:*
{job_data.get('description', 'No description')}

*Requirements:*
{job_data.get('requirements', 'Not specified')}

*Expires in:* 30 days
"""
    
    keyboard = [
        [
            InlineKeyboardButton("‚úÖ Publish Job", callback_data="publish_job"),
            InlineKeyboardButton("‚úèÔ∏è Edit Again", callback_data="edit_job")
        ],
        [InlineKeyboardButton("‚ùå Cancel", callback_data="cancel_job")]
    ]
    
    await query.message.reply_text(
        preview_text,
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return JOB_CONFIRM

async def publish_job(update: Update, context: CallbackContext):
    """Save job to database"""
    query = update.callback_query
    await query.answer()
    
    job_data = context.user_data
    user_id = update.effective_user.id
    
    # Calculate expiry date (30 days from now)
    expires_at = datetime.now() + timedelta(days=30)
    
    cursor = db.get_cursor()
    cursor.execute("""
        INSERT INTO jobs 
        (employer_id, title, company, description, requirements, salary_range, 
         location, job_type, category, expires_at)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
    """, (
        user_id,
        job_data['job_title'],
        job_data.get('company'),
        job_data.get('description'),
        job_data.get('requirements'),
        job_data.get('salary_range'),
        job_data.get('location'),
        job_data.get('job_type', 'full_time'),
        job_data.get('category'),
        expires_at
    ))
    
    job_id = cursor.lastrowid
    db.connection.commit()
    cursor.close()
    
    # Clear conversation data
    context.user_data.clear()
    
    await query.message.reply_text(
        f"‚úÖ *Job Published Successfully!*\n\n"
        f"Your job *{job_data['job_title']}* has been published.\n"
        f"Job ID: *#{job_id}*\n\n"
        f"üîó Share this ID with applicants: `#{job_id}`\n\n"
        f"You can:\n"
        f"‚Ä¢ View applicants with /myjobs\n"
        f"‚Ä¢ Edit job with /editjob {job_id}\n"
        f"‚Ä¢ Delete job with /deletejob {job_id}",
        parse_mode="Markdown"
    )
    
    return ConversationHandler.END
