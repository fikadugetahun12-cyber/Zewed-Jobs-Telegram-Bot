import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext
from dotenv import load_dotenv

load_dotenv()

class SupportBot:
    def __init__(self):
        self.token = os.getenv("SUPPORT_BOT_TOKEN")
        
    async def start(self, update: Update, context: CallbackContext):
        """Start command for support bot"""
        await update.message.reply_text(
            "ðŸ‘‹ *Zewed Jobs Support Bot*\n\n"
            "I'm here to help with:\n"
            "â€¢ Account issues\n"
            "â€¢ Payment problems\n"
            "â€¢ Technical support\n"
            "â€¢ General inquiries\n\n"
            "How can I assist you today?",
            parse_mode="Markdown"
        )
    
    async def handle_message(self, update: Update, context: CallbackContext):
        """Handle user messages in support bot"""
        user_message = update.message.text.lower()
        
        # Keyword-based responses
        if any(word in user_message for word in ['payment', 'money', 'refund', 'telebirr']):
            response = "ðŸ’³ *Payment Support*\n\nFor payment issues:\nâ€¢ Call: +251 911 234 568 (24/7)\nâ€¢ Email: payments@zewedjobs.com\nâ€¢ Include transaction ID"
        
        elif any(word in user_message for word in ['job', 'post', 'listing', 'employer']):
            response = "ðŸ“‹ *Job Posting Support*\n\nFor job-related issues:\nâ€¢ Email: support@zewedjobs.com\nâ€¢ Include job ID if applicable"
        
        elif any(word in user_message for word in ['account', 'login', 'profile', 'password']):
            response = "ðŸ‘¤ *Account Support*\n\nFor account issues:\nâ€¢ Use /profile in main bot\nâ€¢ Email: support@zewedjobs.com\nâ€¢ We'll respond within 24 hours"
        
        else:
            response = "ðŸ“¨ *General Support*\n\nI'll forward your message to our team.\n\nExpected response time: 24 hours\n\nFor urgent issues, call: +251 924858244"
        
        # Forward to main support channel
        await self.forward_to_support_channel(update, context)
        
        await update.message.reply_text(response, parse_mode="Markdown")
    
    async def forward_to_support_channel(self, update: Update, context: CallbackContext):
        """Forward message to support channel"""
        support_channel_id = os.getenv("SUPPORT_CHANNEL_ID")
        
        if support_channel_id:
            user = update.effective_user
            message = f"""
ðŸš¨ *Support Request*

*From:* {user.first_name} {user.last_name or ''}
*Username:* @{user.username or 'N/A'}
*User ID:* {user.id}

*Message:*
{update.message.text}

*Time:* {update.message.date}
"""
            
            await context.bot.send_message(
                chat_id=support_channel_id,
                text=message,
                parse_mode="Markdown"
            )

def main():
    bot = SupportBot()
    application = Application.builder().token(bot.token).build()
    
    application.add_handler(CommandHandler("start", bot.start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, bot.handle_message))
    
    print("ðŸ¤– Support Bot is starting...")
    application.run_polling()

if __name__ == "__main__":
    main()
