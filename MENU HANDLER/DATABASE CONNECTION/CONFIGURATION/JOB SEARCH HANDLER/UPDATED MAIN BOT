import os
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ConversationHandler, CallbackQueryHandler
from dotenv import load_dotenv
from database import db

# Import handlers
from handlers.menu import start, handle_menu, get_main_menu
from handlers.profile import (
    start_profile, save_profile_name, save_profile_phone, save_profile_email,
    save_profile_data, show_profile, edit_profile,
    PROFILE_NAME, PROFILE_PHONE, PROFILE_EMAIL, PROFILE_TYPE, PROFILE_EXPERIENCE, PROFILE_EDUCATION, PROFILE_SKILLS
)
from handlers.jobs import (
    start_job_post, save_job_title, save_job_company, save_job_description,
    save_job_requirements, save_job_salary, save_job_location, save_job_type,
    save_job_category, publish_job,
    JOB_TITLE, JOB_COMPANY, JOB_DESCRIPTION, JOB_REQUIREMENTS, JOB_SALARY, JOB_LOCATION, JOB_TYPE, JOB_CATEGORY, JOB_CONFIRM
)
from handlers.search import search_jobs, browse_categories, show_jobs_by_category, view_job_details

load_dotenv()

def main():
    # Connect to database
    if not db.connect():
        print("‚ùå Failed to connect to database. Exiting...")
        return
    
    # Get token from environment
    TOKEN = os.getenv("BOT_TOKEN")
    if not TOKEN:
        print("‚ùå ERROR: BOT_TOKEN not found in .env file")
        return
    
    # Create application
    application = Application.builder().token(TOKEN).build()
    
    # Profile conversation handler
    profile_conv = ConversationHandler(
        entry_points=[CommandHandler("profile", start_profile),
                     MessageHandler(filters.Regex("^(üë§ My Profile)$"), start_profile)],
        states={
            PROFILE_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_profile_name)],
            PROFILE_PHONE: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_profile_phone)],
            PROFILE_EMAIL: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_profile_email)],
            PROFILE_TYPE: [CallbackQueryHandler(save_profile_data, pattern="^type_")],
        },
        fallbacks=[CommandHandler("cancel", lambda u, c: ConversationHandler.END)],
        allow_reentry=True
    )
    
    # Job posting conversation handler
    job_post_conv = ConversationHandler(
        entry_points=[CommandHandler("post", start_job_post),
                     MessageHandler(filters.Regex("^(üìù Post Job)$"), start_job_post)],
        states={
            JOB_TITLE: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_job_title)],
            JOB_COMPANY: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_job_company)],
            JOB_DESCRIPTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_job_description)],
            JOB_REQUIREMENTS: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_job_requirements)],
            JOB_SALARY: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_job_salary)],
            JOB_LOCATION: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_job_location)],
            JOB_TYPE: [CallbackQueryHandler(save_job_type, pattern="^type_")],
            JOB_CATEGORY: [CallbackQueryHandler(save_job_category, pattern="^cat_")],
            JOB_CONFIRM: [CallbackQueryHandler(publish_job, pattern="^publish_job$")]
        },
        fallbacks=[CallbackQueryHandler(lambda u, c: ConversationHandler.END, pattern="^cancel_job$")],
        allow_reentry=True
    )
    
    # Add handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", start))
    application.add_handler(CommandHandler("search", search_jobs))
    application.add_handler(CommandHandler("jobs", search_jobs))
    
    application.add_handler(profile_conv)
    application.add_handler(job_post_conv)
    
    # Callback query handlers
    application.add_handler(CallbackQueryHandler(browse_categories, pattern="^browse_categories$"))
    application.add_handler(CallbackQueryHandler(show_jobs_by_category, pattern="^category_"))
    application.add_handler(CallbackQueryHandler(view_job_details, pattern="^view_job_"))
    application.add_handler(CallbackQueryHandler(search_jobs, pattern="^back_to_search$"))
    
    # Menu handler (should be last)
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_menu))
    
    # Start bot
    print("ü§ñ Zewed Jobs Bot is starting...")
    print("‚úÖ Database connected")
    print("‚úÖ Handlers loaded")
    print("‚úÖ Bot is running. Press Ctrl+C to stop.")
    
    application.run_polling()

if __name__ == "__main__":
    main()
