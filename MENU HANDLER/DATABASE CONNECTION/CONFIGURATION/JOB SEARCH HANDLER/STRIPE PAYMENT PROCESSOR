import stripe
from config import Config

class StripePayment:
    def __init__(self):
        # Initialize Stripe with your API keys
        stripe.api_key = Config.STRIPE_SECRET_KEY
        self.webhook_secret = Config.STRIPE_WEBHOOK_SECRET
        
    def create_payment_intent(self, amount, currency, description, customer_email=None, metadata=None):
        """
        Create a Stripe Payment Intent
        
        Args:
            amount: Amount in smallest currency unit (e.g., cents for USD)
            currency: Currency code (e.g., 'usd', 'etb')
            description: Payment description
            customer_email: Customer email
            metadata: Additional metadata
        """
        try:
            payment_intent_data = {
                "amount": int(amount * 100),  # Convert to cents
                "currency": currency.lower(),
                "description": description,
                "automatic_payment_methods": {
                    "enabled": True,
                },
                "metadata": metadata or {}
            }
            
            if customer_email:
                payment_intent_data["receipt_email"] = customer_email
            
            payment_intent = stripe.PaymentIntent.create(**payment_intent_data)
            
            return {
                "success": True,
                "client_secret": payment_intent.client_secret,
                "payment_intent_id": payment_intent.id,
                "amount": amount,
                "currency": currency
            }
            
        except stripe.error.StripeError as e:
            return {"success": False, "error": str(e)}
    
    def create_checkout_session(self, amount, currency, description, success_url, cancel_url, metadata=None):
        """Create Stripe Checkout session"""
        try:
            session = stripe.checkout.Session.create(
                payment_method_types=['card'],
                line_items=[{
                    'price_data': {
                        'currency': currency.lower(),
                        'product_data': {
                            'name': description,
                        },
                        'unit_amount': int(amount * 100),  # Convert to cents
                    },
                    'quantity': 1,
                }],
                mode='payment',
                success_url=success_url,
                cancel_url=cancel_url,
                metadata=metadata or {}
            )
            
            return {
                "success": True,
                "session_id": session.id,
                "url": session.url
            }
            
        except stripe.error.StripeError as e:
            return {"success": False, "error": str(e)}
    
    def verify_webhook_signature(self, payload, sig_header):
        """Verify Stripe webhook signature"""
        try:
            event = stripe.Webhook.construct_event(
                payload, sig_header, self.webhook_secret
            )
            return {"success": True, "event": event}
        except ValueError as e:
            return {"success": False, "error": "Invalid payload"}
        except stripe.error.SignatureVerificationError as e:
            return {"success": False, "error": "Invalid signature"}
